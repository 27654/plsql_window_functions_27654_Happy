SELECT c.CUSTOMERID, c.CUSTOMERNAME
FROM CUSTOMERS c
LEFT JOIN TRANSACTIONS t ON c.CUSTOMERID = t.CUSTOMERID
WHERE t.TRANSACTIONID IS NULL;


-- LEFT JOIN: List products that have never been sold
SELECT
    p.PRODUCTID,
    p.PRODUCTNAME,
    t.TRANSACTIONID
FROM PRODUCTS p
LEFT JOIN TRANSACTIONS t
    ON p.PRODUCTID = t.PRODUCTID
WHERE t.TRANSACTIONID IS NULL;


-- FULL OUTER JOIN: Compare customers and products including unmatched records

SELECT
    c.CUSTOMERID,
    c.CUSTOMERNAME,
    p.PRODUCTID,
    p.PRODUCTNAME,
    t.TRANSACTIONID
FROM CUSTOMERS c
LEFT JOIN TRANSACTIONS t
    ON c.CUSTOMERID = t.CUSTOMERID
LEFT JOIN PRODUCTS p
    ON t.PRODUCTID = p.PRODUCTID

UNION

SELECT
    c.CUSTOMERID,
    c.CUSTOMERNAME,
    p.PRODUCTID,
    p.PRODUCTNAME,
    t.TRANSACTIONID
FROM PRODUCTS p
LEFT JOIN TRANSACTIONS t
    ON p.PRODUCTID = t.PRODUCTID
LEFT JOIN CUSTOMERS c
    ON t.CUSTOMERID = c.CUSTOMERID;


-- SELF JOIN: customers in the same region
SELECT
    c1.CUSTOMERID AS CUSTOMER1_ID,
    c1.CUSTOMERNAME AS CUSTOMER1_NAME,
    c2.CUSTOMERID AS CUSTOMER2_ID,
    c2.CUSTOMERNAME AS CUSTOMER2_NAME,
    c1.REGION
FROM CUSTOMERS c1
INNER JOIN CUSTOMERS c2
    ON c1.REGION = c2.REGION
    AND c1.CUSTOMERID < c2.CUSTOMERID; -- avoid duplicate pairs


-- Calculate total revenue per customer and rank them
SELECT 
    c.CUSTOMERNAME,
    SUM(t.QUANTITY * p.PRICE) AS TOTAL_REVENUE,
    ROW_NUMBER() OVER (ORDER BY SUM(t.QUANTITY * p.PRICE) DESC) AS RN,
    RANK() OVER (ORDER BY SUM(t.QUANTITY * p.PRICE) DESC) AS RANKING,
    DENSE_RANK() OVER (ORDER BY SUM(t.QUANTITY * p.PRICE) DESC) AS DENSE_RANKING,
    PERCENT_RANK() OVER (ORDER BY SUM(t.QUANTITY * p.PRICE) DESC) AS PERCENT_RANKING
FROM TRANSACTIONS t
JOIN CUSTOMERS c ON t.CUSTOMERID = c.CUSTOMERID
JOIN PRODUCTS p ON t.PRODUCTID = p.PRODUCTID
GROUP BY c.CUSTOMERNAME
ORDER BY TOTAL_REVENUE DESC;
